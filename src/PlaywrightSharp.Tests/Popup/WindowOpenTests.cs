using System.Collections.Generic;
using System.Threading.Tasks;
using PlaywrightSharp.Tests.BaseTests;
using Xunit;
using Xunit.Abstractions;

namespace PlaywrightSharp.Tests.Popup
{

    ///<playwright-file>popup.spec.js</playwright-file>
    ///<playwright-describe>window.open</playwright-describe>
    [Collection(TestConstants.TestFixtureBrowserCollectionName)]
    public class WindowOpenTests : PlaywrightSharpBrowserBaseTest
    {
        /// <inheritdoc/>
        public WindowOpenTests(ITestOutputHelper output) : base(output)
        {
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>should inherit user agent from browser context</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task ShouldInheritUserAgentFromBrowserContext()
        {
            await using var context = await Browser.NewContextAsync(new BrowserContextOptions { UserAgent = "hey" });
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);
            var requestTcs = new TaskCompletionSource<string>();
            _ = Server.WaitForRequest("/dummy.html", request => requestTcs.TrySetResult(request.Headers["user-agent"]));

            string userAgent = await page.EvaluateAsync<string>(@"url => {
                const win = window.open(url);
                return win.navigator.userAgent;
            }", TestConstants.ServerUrl + "/dummy.html");
            await requestTcs.Task;

            Assert.Equal("hey", userAgent);
            Assert.Equal("hey", requestTcs.Task.Result);
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>should inherit extra headers from browser context</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task ShouldInheritExtraHeadersFromBrowserContext()
        {
            await using var context = await Browser.NewContextAsync(new BrowserContextOptions
            {
                ExtraHttpHeaders = new Dictionary<string, string>
                {
                    ["foo"] = "bar"
                }
            });
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);
            var requestTcs = new TaskCompletionSource<string>();
            _ = Server.WaitForRequest("/dummy.html", request => requestTcs.TrySetResult(request.Headers["foo"]));

            await page.EvaluateAsync(@"url => window._popup = window.open(url)", TestConstants.ServerUrl + "/dummy.html");
            await requestTcs.Task;

            Assert.Equal("bar", requestTcs.Task.Result);
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>should inherit offline from browser context</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task ShouldInheritOfflineFromBrowserContext()
        {
            await using var context = await Browser.NewContextAsync();
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);
            await context.SetOfflineAsync(true);

            bool online = await page.EvaluateAsync<bool>(@"url => {
                const win = window.open(url);
                return win.navigator.onLine;
            }", TestConstants.ServerUrl + "/dummy.html");

            await page.EvaluateAsync(@"url => window._popup = window.open(url)", TestConstants.ServerUrl + "/dummy.html");

            Assert.False(online);
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>should inherit http credentials from browser context</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task ShouldInheritHttpCredentialsFromBrowserContext()
        {
            Server.SetAuth("/title.html", "user", "pass");
            await using var context = await Browser.NewContextAsync(new BrowserContextOptions
            {
                HttpCredentials = new Credentials() { Username = "user", Password = "pass" },
            });
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);
            var popup = page.WaitForEventAsync(PageEvent.Popup);

            await TaskUtils.WhenAll(
                popup,
                page.EvaluateAsync("url => window._popup = window.open(url)", TestConstants.ServerUrl + "/title.html"));

            await popup.Result.Page.WaitForLoadStateAsync(LifecycleEvent.DOMContentLoaded);
            Assert.Equal("Woof-Woof", await popup.Result.Page.GetTitleAsync());
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>should inherit touch support from browser context</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task ShouldInheritTouchSupportFromBrowserContext()
        {
            await using var context = await Browser.NewContextAsync(new BrowserContextOptions
            {
                Viewport = new ViewportSize { Width = 400, Height = 500 },
                HasTouch = true,
            });
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);

            bool hasTouch = await page.EvaluateAsync<bool>(@"() => {
                const win = window.open('');
                return 'ontouchstart' in win;
            }");

            Assert.True(hasTouch);
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>should inherit viewport size from browser context</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task ShouldInheritViewportSizeFromBrowserContext()
        {
            await using var context = await Browser.NewContextAsync(new BrowserContextOptions
            {
                Viewport = new ViewportSize { Width = 400, Height = 500 },
            });
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);

            var size = await page.EvaluateAsync<ViewportSize>(@"() => {
                const win = window.open('about:blank');
                return { width: win.innerWidth, height: win.innerHeight };
            }");

            Assert.Equal(new ViewportSize { Width = 400, Height = 500 }, size);
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>should use viewport size from window features</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task ShouldUseViewportSizeFromWindowFeatures()
        {
            await using var context = await Browser.NewContextAsync(new BrowserContextOptions
            {
                Viewport = new ViewportSize { Width = 700, Height = 700 },
            });
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);

            var (size, popup) = await TaskUtils.WhenAll(
                page.EvaluateAsync<ViewportSize>(@"() => {
                    const win = window.open(window.location.href, 'Title', 'toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=600,height=300,top=0,left=0');
                    return { width: win.innerWidth, height: win.innerHeight };
                }"),
                page.WaitForEventAsync(PageEvent.Popup));

            await popup.Page.SetViewportSizeAsync(new ViewportSize { Width = 500, Height = 400 });
            await popup.Page.WaitForLoadStateAsync();
            var resized = await popup.Page.EvaluateAsync<ViewportSize>(@"() => ({ width: window.innerWidth, height: window.innerHeight })");

            Assert.Equal(new ViewportSize { Width = 600, Height = 300 }, size);
            Assert.Equal(new ViewportSize { Width = 500, Height = 400 }, resized);
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>should respect routes from browser context</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task ShouldRespectRoutesFromBrowserContext()
        {
            await using var context = await Browser.NewContextAsync();
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);

            bool intercepted = false;

            await context.RouteAsync("**/empty.html", (route, _) =>
            {
                route.ContinueAsync();
                intercepted = true;
            });

            var popupTask = context.WaitForEventAsync(ContextEvent.Page);
            await TaskUtils.WhenAll(
                popupTask,
                page.EvaluateAsync("url => window.__popup = window.open(url)", TestConstants.EmptyPage));

            Assert.True(intercepted);
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>BrowserContext.addInitScript should apply to an in-process popup</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task BrowserContextAddInitScriptShouldApplyToAnInProcessPopup()
        {
            await using var context = await Browser.NewContextAsync();
            await context.AddInitScriptAsync("() => window.injected = 123");
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);

            int injected = await page.EvaluateAsync<int>(@"() => {
                const win = window.open('about:blank');
                return win.injected;
            }");

            Assert.Equal(123, injected);
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>BrowserContext.addInitScript should apply to a cross-process popup</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task BrowserContextAddInitScriptShouldApplyToACrossProcessPopup()
        {
            await using var context = await Browser.NewContextAsync();
            await context.AddInitScriptAsync("() => window.injected = 123");
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);

            var popup = page.WaitForEventAsync(PageEvent.Popup);

            await TaskUtils.WhenAll(
                popup,
                page.EvaluateAsync("url => window._popup = window.open(url)", TestConstants.CrossProcessUrl + "/title.html"));

            Assert.Equal(123, await popup.Result.Page.EvaluateAsync<int>("injected"));
            await popup.Result.Page.ReloadAsync();
            Assert.Equal(123, await popup.Result.Page.EvaluateAsync<int>("injected"));
        }

        ///<playwright-file>popup.spec.js</playwright-file>
        ///<playwright-describe>window.open</playwright-describe>
        ///<playwright-it>should expose function from browser context</playwright-it>
        [Fact(Timeout = TestConstants.DefaultTestTimeout)]
        public async Task ShouldExposeFunctionFromBrowserContext()
        {
            await using var context = await Browser.NewContextAsync();
            await context.ExposeFunctionAsync("add", (int a, int b) => a + b);
            var page = await context.NewPageAsync();
            await page.GoToAsync(TestConstants.EmptyPage);

            int injected = await page.EvaluateAsync<int>(@"() => {
                const win = window.open('about:blank');
                return win.add(9, 4);
            }");

            Assert.Equal(13, injected);
        }
    }
}
