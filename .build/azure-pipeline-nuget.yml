trigger: none # We don't want CI builds, just a manual release process
pool: $(PlaywrightPoolName)
parameters:
  - name: doRelease
    displayName: Push the Release to NuGet.org
    default: false
    type: boolean

  - name: signType
    displayName: Sign Type
    default: 'test'
    type: string
    values:
    - test
    - real

stages:
- stage: BuildPackageSign
  displayName: Build, Package & Sign
  jobs:
  - job: BuildPackage
    displayName: Build & Package
    steps:

    - task: MicroBuildSigningPlugin@3
      inputs:
        signType: '${{ parameters.signType }}'
        feedSource: 'https://devdiv.pkgs.visualstudio.com/DefaultCollection/_packaging/MicroBuildToolset/nuget/v3/index.json'
        
      # We need to download the browsers first, so we can build
    - task: DotNetCoreCLI@2
      inputs:
        command: 'run'
        arguments: '-p $(Build.SourcesDirectory)/src/tools/PlaywrightSharp.Tooling/PlaywrightSharp.Tooling.csproj -- download-drivers --basepath $(Build.SourcesDirectory)'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'build'
        projects: '**/Playwright.csproj'
        arguments: '-c $(BuildConfiguration)'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'pack'
        packagesToPack: '**/Playwright.csproj'
        packDirectory: '$(Build.ArtifactStagingDirectory)/nuget'
        versioningScheme: 'off'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/nuget'
        ArtifactName: 'drop'
        publishLocation: 'Container'

    - task: MicroBuildCleanup@1

- stage: Release
  jobs:
  - job: ReleaseNuget
    displayName: Publish on Nuget.org
    condition: and(succeeded(), eq('${{parameters.doRelease}}', true))

    steps:
    - checkout: none
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'drop'
        downloadPath: '$(System.ArtifactsDirectory)'
        extractTars: true

    - task: NuGetCommand@2
      inputs:
        command: 'push'
        packagesToPush: '$(System.ArtifactsDirectory)/**/*.nupkg;!$(System.ArtifactsDirectory)/**/*.symbols.nupkg'
        nuGetFeedType: 'external'
        publishFeedCredentials: 'NuGet-Playwright'